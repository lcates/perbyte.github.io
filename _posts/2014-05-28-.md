---
layout:     post
date:       2014-05-28
title:      "Aptify Ebusiness Image Handler"
meta:       "Nothing to do with Chelsea Handler"
description: ""
comments:   true
author:     jason
categories:
tags:       aptify asp.net
---

First off, as this is my first post, let me introduce myself. I am Josh's #1 peon, er, esteemed colleague, at [PerByte][perb]. And this is apparently what [Google][goog] and [Bing][bing] identify as an "image handler":

This post has nothing to do with [Chelsea Handler][chel], but I am about to drop a metaphorical bomb on you. If you don't happen to be an [Aptify][apt] developer, I'm truly sorry. Here goes.

```C#
<%@ WebHandler Language="C#" Class="AptifyProfilePicture" %>

using System;
using System.Data;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Drawing.Imaging;
using System.IO;
using System.Net;
using System.Web;
using Aptify.Framework.Application;
using Aptify.Framework.Web.eBusiness;

public class ProfilePicture : IHttpHandler
{
    /// <summary>
    /// Gets a value indicating that this <see cref="IHttpHandler" /> is not reusable.
    /// </summary>
    public bool IsReusable
    {
        get { return false; }
    }

    /// <summary>
    /// Processes the request (the entry point for the <see cref="IHttpHandler" />).
    /// </summary>
    /// <param name="context">The <see cref="HttpContext" /> to use to process the request.</param>
    public void ProcessRequest(HttpContext context)
    {
        // Instantiate the Aptify data helper objects
        var global = new EBusinessGlobal();
        var application = global.GetAptifyApplication(HttpContext.Current.Application, HttpContext.Current.User);
        var dataAction = global.GetDataAction(HttpContext.Current.Application, HttpContext.Current.User);

        // Parse the id from the request
        int personId;

        if (!int.TryParse(HttpContext.Current.Request["id"], out personId))
        {
            throw new InvalidOperationException("id parameter is required.");
        }

        // Attempt to retrieve the image from the Aptify database
        string sql = @"

        SELECT TOP 1 CONVERT(varbinary(MAX), BlobData) 'Photo'
	    FROM {0}..vwAttachments
		WHERE RecordID = @PersonID AND
		    Entity = 'Persons' AND
			CategoryID = 6
		ORDER BY DateUpdated DESC

        ";

        sql = string.Format(sql, application.GetEntityBaseDatabase("Attachments"));

        var parameters = new[] { dataAction.GetDataParameter("@PersonID", SqlDbType.Int, personId) };

        using (var reader = dataAction.ExecuteDataReaderParametrized(sql, CommandType.Text, parameters, CommandBehavior.CloseConnection))
        {
            var buffer = reader.Read() ? GetAllBytes(reader, "Photo") : LoadNoImage();

            if (buffer == null)
            {
                // Unable to find the person in the database
                HttpContext.Current.Response.StatusCode = (int)HttpStatusCode.NotFound;
                HttpContext.Current.Response.End();
            }
            else
            {
                // We have our image buffer, so time to process and write the image out to the response
                this.HandleImage(buffer);
            }
        }
    }

    /// <summary>
    /// Processes the image from the specified buffer and writes it out to the response.
    /// </summary>
    /// <param name="buffer">The byte array buffer that contains the image to process and send.</param>
    private void HandleImage(byte[] buffer)
    {
        using (var image = GetImageFromByteArray(buffer))
        {
            int width = image.Width;
            int height = image.Height;
            double ratio = width * 1.0 / height;

            if (int.TryParse(HttpContext.Current.Request["w"], out width))
            {
                // Width was specified, so dynamically set the height
                height = (int)(width / ratio);
            }
            else if (int.TryParse(HttpContext.Current.Request["h"], out height))
            {
                // Height was specified, so dynamically set the width
                width = (int)(height * ratio);
            }

            // Resize and write the image out to the response
            using (var resizedImage = ResizeImage(image, width, height))
            {
                HttpContext.Current.Response.ContentType = "image/png";
                HttpContext.Current.Response.BinaryWrite(GetByteArrayFromImage(resizedImage, ImageFormat.Png));
            }
        }
    }

    /// <summary>
    /// Returns a byte array buffer that contains the default image.
    /// </summary>
    /// <returns>The byte array buffer that contains the default image.</returns>
    private static byte[] LoadNoImage()
    {
        return File.ReadAllBytes(HttpContext.Current.Server.MapPath("~/assets/img/not-found.jpg"));
    }

    /// <summary>
    /// Gets a byte array from a column in an <see cref="IDataReader" />.
    /// </summary>
    /// <param name="reader">The <see cref="IDataReader" /> object to retrieve the data from.</param>
    /// <param name="name">The name of the column to retrieve.</param>
    /// <returns>A byte array representing the contents of the column.</returns>
    private static byte[] GetAllBytes(IDataReader reader, string name)
    {
        if (reader == null)
        {
            throw new ArgumentNullException("reader");
        }

        int ordinal = reader.GetOrdinal(name);

        var size = reader.GetBytes(ordinal, 0, null, 0, 0);

        if (size > int.MaxValue)
        {
            throw new InvalidOperationException();
        }

        var buffer = new byte[size];
        reader.GetBytes(ordinal, 0, buffer, 0, (int)size);

        return buffer;
    }

    /// <summary>
    /// Gets an <see cref="Image" /> from a byte array buffer.
    /// </summary>
    /// <param name="buffer">The byte array buffer to convert to an <see cref="Image" />.</param>
    /// <returns>The <see cref="Image" /> object converted from the byte array buffer.</returns>
    private static Image GetImageFromByteArray(byte[] buffer)
    {
        if (buffer == null)
        {
            throw new ArgumentNullException("buffer");
        }

        using (var memoryStream = new MemoryStream(buffer))
        {
            return Image.FromStream(memoryStream);
        }
    }

    /// <summary>
    /// Converts the specified <see cref="Image" /> to a byte array using the specified format.
    /// </summary>
    /// <param name="image">The <see cref="Image" /> to convert.</param>
    /// <param name="format">The <see cref="ImageFormat" /> to use when serializing.</param>
    /// <returns>The byte array representation of the image.</returns>
    public static byte[] GetByteArrayFromImage(Image image, ImageFormat format)
    {
        if (image == null)
        {
            throw new ArgumentNullException("image");
        }

        using (var stream = new MemoryStream())
        {
            image.Save(stream, format);
            return stream.ToArray();
        }
    }

    /// <summary>
    /// Resizes the specified <see cref="Image" />.
    /// </summary>
    /// <param name="image">The <see cref="Image" /> that you wish to resize.</param>
    /// <param name="width">The desired width of the resulting image.</param>
    /// <param name="height">The desired height of the resulting image.</param>
    /// <returns>The resulting resized <see cref="Image" /> object.</returns>
    private static Image ResizeImage(Image image, int width, int height)
    {
        if (image == null)
        {
            throw new ArgumentNullException("image");
        }

        var bitmap = new Bitmap(width, height);

        try
        {
            // Get the graphics object, set it up for quality resizing, and resize
            using (var g = Graphics.FromImage(bitmap))
            {
                g.InterpolationMode = InterpolationMode.HighQualityBicubic;
                g.SmoothingMode = SmoothingMode.HighQuality;
                g.CompositingQuality = CompositingQuality.HighQuality;
                g.DrawImage(image, 0, 0, width, height);
            }

            return bitmap;
        }
        catch
        {
            bitmap.Dispose();
            throw;
        }
    }
}
```

Boom. There's more helpful code here for an Aptify Ebusiness developer than what is immediately apparent. This code shows you:

- How to retrieve EBusinessGlobal, AptifyApplication, and DataAction classes for data access if they're not immediately available to you
- How to create an HTTP Handler with access to Aptify
- How to read binary data from attachments in Aptify
- And ultimately, how to create a generic handler to dyamically size and download profile pictures from persons in Aptify

To use this code in your Aptify Ebusiness website, simply create a new Generic Handler in Visual Studio, call it AptifyProfilePicture.ashx, and paste the above code into it.

Then, to show a person's profile picture on a page, you can simply put an image tag in your markup like this:

```html
<img src="/AptifyProfilePicture.ashx?id=2353&w=200" alt="Fred" />
```

Obviously, make sure that the path to AptifyProfilePicture.ashx matches the location of the handler that you created above. The id query string parameter is of course the PersonID of the person whose profile picture you'd like to display. This will resize the image to a maximum of 200 pixels wide, and adjust the height based on the correct aspect ratio. To use a maximum height instead, simply use the "h" query string parameter in place of the "w" like this:

```html
<img src="/AptifyProfilePicture.ashx?id=2353&h=300" alt="Fred" />
```

I would hope the rest of this is mostly self explanatory, but please feel free to chime in in the comments if you need assistance; Josh and I are excited to share some of our Aptify development expertise to hopefully reduce the learning curve for Aptify developers.

[perb]: http://www.perbyte.com/
[goog]: https://www.google.com/#q=image+handler
[bing]: http://www.bing.com/search?q=image+handler
[chel]: http://www.imdb.com/name/nm1314546/?ref_=fn_al_nm_1
[apt]: http://www.aptify.com/